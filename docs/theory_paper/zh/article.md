# 密码管理器与硬件密钥的深度思考

在使用了多款密码管理器之后，我对密码管理领域有了一些个人思考。首先，我们为什么要使用密码管理器？如果不使用密码管理器，大多数人要么会选择只记一个或几个密码，而这些密码由于需要记忆，通常随机熵不够高，容易被暴力破解。如果用户在所有平台都使用相同的密码，一旦某个应用被黑客入侵，且该应用在密钥推导或哈希存储的实施上存在问题（例如未加盐，甚至明文存储密码），攻击者就能获得用户的明文密码，进而入侵用户的其他账户。因此，密码管理器的核心价值在于生成高熵密码并避免密码重复使用，从而降低被攻击的风险。

然而，密码管理器本身并非完美。我曾使用过Google和Apple的密码管理器，也用过开源的Bitwarden和KeePass。商业密码管理器存在商业公司为经济利益背叛用户的风险，以及内部人员的内鬼行为，而由于不开源，在这些风险成为现实时，人们难以得知，更别提监督和防范。此外，所有密码管理器都存在单点故障问题：一旦攻击者获得对主密码或主账户的访问权限（例如通过入侵设备或窃取Cookie），就可以解锁整个密码管理器中的所有机密信息。

## 硬件密钥的优势与挑战

硬件密钥（如FIDO2）在一定程度上缓解了这些问题。硬件密钥通常比个人设备更安全，因为它们不会安装第三方软件，攻击面较小，且难以在线破解。FIDO2方案允许在硬件密钥设备上安全地使用私钥进行解密、签名和登录操作，即使攻击者控制了用户的设备，也只能获得单个平台的短期登录凭证。

然而，硬件密钥仍存在一些攻击面：

1. **FIDO2实施不完善**：目前支持FIDO2的应用较少，且部分平台（如Apple和三星）限制了硬件密钥的品牌。例如，ProtonMail仅支持将FIDO2作为双因素认证（2FA）手段，而不能完全替代密码。
   
2. **备份问题**：硬件密钥的备份机制存在缺陷。例如，Google允许将安卓手机作为硬件密钥，但其备份依赖于Google账户的访问权限，存在与密码管理器相同的单点故障风险。而YubiKey等设备需要用户购买多个硬件密钥并复制私钥，这可能导致备份设备因老化或自然灾害（如火灾、洪水、地震）而损坏。

3. **缺乏屏幕和按钮**：许多硬件密钥设备没有屏幕或按钮，用户无法确认自己正在批准的操作。攻击者可以在用户登录A平台时，同时发起对B平台的FIDO2请求，用户可能在不知情的情况下批准了攻击者希望的另外的操作。再比如，用户以为自己在解密一个不太重要的信息（比如加密后的电子邮件），但实际上攻击者同时发起了对密码管理器数据库的解密请求。

硬件加密货币钱包（如Trezor和Ledger）在这一领域走在了前列。它们通常配备屏幕和按钮，如果支持足够好，用户可以清楚地看到自己正在批准的操作。此外，BIP39助记词备份机制通过24个单词备份256位私钥或随机种子，用户可以通过抄写多份助记词或将其刻在不锈钢板上来防止私钥丢失。沙米尔备份（Shamir Backup）进一步提高了备份的抗风险能力。

## 我的选择与方案设计

基于以上分析，我选择了Trezor作为硬件密钥设备，主要原因是其开源特性，一方面我会更信任开源方案，另一方面我会对未来的可拓展性能有更多期待。尽管Trezor在加密解密功能上存在一些瑕疵（如无法完全确认正在解密的内容），但其安全性仍优于传统方案。为了进一步提升安全性，我设计了一款基于Trezor的密码管理器，采用以下方案：

1. **以太坊签名生成随机种子**：通过以太坊签名生成130位十六进制签名结果，使用SHA256哈希生成256位随机数，进而生成密钥对。

2. **分层加密**：为每个密码或机密信息生成独立的“主密码”，并通过以太坊签名加密。例如，为Twitter账号`ryder1987@gmail.com`的密码加密时，生成描述字符串（如“`ryder1987@gmail.com`在`Twitter.com`中存储的密码”），并使用冷门的BIP32派生路径（如`m/44h/60h/11h/0/12`）签名该字符串，生成密钥对后使用公钥加密密码。这种冷门路径不会影响主钱包（如`m/44h/60h/1h/0/1`）的安全。

3. **身份组管理**：将密码管理器中的信息分为多个身份组（Identity Group），部分身份组（如日常社交账号）不加密用户名和密码，而敏感身份组（如调查记者使用的账号）则加密所有信息，并使用误导性名称（如“`ryder`注册的色情网站”）保护隐私。

例如，我在推特上的用户名为`ryder1987@gmail.com`的Twitter账号，想为这个账号对应的自动安全生成的强密码进行加密然后存储，那么我就会先根据一定格式制作一个字符串，比如说这个字符串为“`ryder1987@gmail.com`在`Twitter.com`这个APP中存储的密码进行解密操作”，并使用一般不会用到的一个BIP32派生路径比如`m/44h/60h/11h/0/12`去签名这段字符串，也就是说不会影响到以太坊默认主钱包`m/44h/60h/1h/0/1`的资金安全。将签名结果按照我之前所说的方式生成密钥对，然后使用公钥对密码进行加密，最后把公钥加密后的内容和这个字符串（也就是hint）以及BIP32路径存储起来。这样之后在需要使用这个密码时，重新通过对hint签名，获得私钥用私钥解密加密后的密码数据就可以获得密码了。

### 方案优势

- **分散风险**：每个密码都有独立的“主密码”，增加了攻击难度。
- **分层加密**：即使部分信息泄露，其他信息仍保持安全。例如，攻击者即使入侵了设备，也只能获取解密后的有限信息（如当前解密的密码），而无法获取其他未解密的密码或加密的身份组下的用户名集合。
- **硬件级安全性**：使用硬件钱包进行签名，避免了主密码被暴力破解或私钥文件存储在设备磁盘上的风险。
- **防止盲解密**：通过描述字符串和冷门BIP32路径，用户可以明确知道正在解密的内容，避免了盲解密或盲签名的风险。
